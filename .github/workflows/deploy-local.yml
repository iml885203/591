name: Deploy to Local Docker

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        echo "DEPLOYMENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "JOB_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
        
    - name: Create deployment env file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        DATABASE_PROVIDER=postgresql
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
        API_KEY=${{ secrets.API_KEY }}
        NOTIFICATION_DELAY=1000
        API_PORT=3000
        SAVE_DEBUG_HTML="true"
        SKIP_DB_OPTIMIZATION="true"
        DEBUG_LOGS="false"
        EOF
        echo "=== Created .env.production file ==="
        cat .env.production
        echo "=================================="
        
    - name: Build new images
      run: |
        echo "üî® Building new images..."
        docker-compose -f docker-compose.production.yml build
        
    - name: Deploy
      run: |
        echo "üöÄ Deploying..."
        docker-compose -f docker-compose.production.yml down || true
        docker-compose -f docker-compose.production.yml up -d
        
        echo "‚è≥ Waiting for API..."
        for i in {1..24}; do
          if curl -sf http://localhost:3001/health > /dev/null; then
            echo "‚úÖ API is healthy after $((i*5)) seconds!"
            break
          fi
          echo "Checking API health... (attempt $i/24)"
          sleep 5
        done
        
        # Final verification
        curl -f http://localhost:3001/health && echo "üéâ Deployment successful!"
        
    - name: Cleanup old images
      run: |
        docker image prune -f || true
        
    - name: Send deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          curl -X POST "${{ secrets.MAINTENANCE_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"üöÄ Local Deployment Successful\",
                \"description\": \"591 Crawler deployed successfully to local Docker\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Commit\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                  {\"name\": \"Time\", \"value\": \"$DEPLOYMENT_TIME\", \"inline\": true},
                  {\"name\": \"Environment\", \"value\": \"Local Docker (Port 3001)\", \"inline\": true},
                  {\"name\": \"URL\", \"value\": \"http://localhost:3001\", \"inline\": true}
                ]
              }],
              \"flags\": 4096
            }" || true
        else
          curl -X POST "${{ secrets.MAINTENANCE_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"‚ùå Local Deployment Failed\",
                \"description\": \"591 Crawler deployment to local Docker failed\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Commit\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                  {\"name\": \"Time\", \"value\": \"$DEPLOYMENT_TIME\", \"inline\": true},
                  {\"name\": \"CI Job\", \"value\": \"[View Logs]($JOB_URL)\", \"inline\": true},
                  {\"name\": \"Action\", \"value\": \"Check the CI logs for detailed error information\", \"inline\": false}
                ]
              }]
            }" || true
        fi